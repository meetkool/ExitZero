stages:
  - docker
  - build
  - release

variables:
  FLUTTER_VERSION: "stable"
  # Speed up Gradle
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true"
  # Custom image tag
  CI_IMAGE: "${CI_REGISTRY_IMAGE}/flutter-builder:latest"

# â”€â”€ Build and push custom Docker image â”€â”€
docker_build:
  stage: docker
  image: docker:latest
  services:
    - docker:dind
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - Dockerfile
      when: on_success
    - when: never
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - docker build -t "$CI_IMAGE" .
    - docker push "$CI_IMAGE"

# â”€â”€ Build release APK â”€â”€
build_apk:
  stage: build
  image: ${CI_IMAGE}
  only:
    - main
  cache:
    # Cache pub packages across runs
    - key: flutter-pub-${CI_COMMIT_REF_SLUG}
      paths:
        - .pub-cache/
        - .dart_tool/
      policy: pull-push
  script:
    - flutter pub get
    - flutter build apk --release
    - |
      VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //')
      TAG="v${VERSION}-build.${CI_PIPELINE_IID}"
      APK_NAME="ExitZero-${TAG}.apk"
      echo "VERSION=$VERSION" >> build.env
      echo "TAG=$TAG" >> build.env
      echo "BUILD_JOB_ID=$CI_JOB_ID" >> build.env
      echo "APK_NAME=$APK_NAME" >> build.env
      mkdir -p release
      mv build/app/outputs/flutter-apk/app-release.apk "release/${APK_NAME}"
      
      # Upload to GitLab Package Registry (Generic)
      echo "Uploading ${APK_NAME} to Package Registry..."
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file "release/${APK_NAME}" \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/exitzero/${VERSION}/${APK_NAME}"
           
      # Also upload as 'latest' for stable URL
      echo "Uploading as latest..."
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file "release/${APK_NAME}" \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/exitzero/latest/ExitZero-latest.apk"
  artifacts:
    paths:
      - release/
    reports:
      dotenv: build.env
    expire_in: 1 week

# â”€â”€ Create GitLab Release with the APK â”€â”€
create_release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  only:
    - main
  needs:
    - job: build_apk
      artifacts: true
  script:
    - echo "Creating release for $TAG"
  release:
    tag_name: "$TAG"
    name: "ExitZero $TAG"
    description: |
      ðŸš€ **Automated release from `main` branch**

      **Commit:** $CI_COMMIT_SHA
      **Pipeline:** #$CI_PIPELINE_IID

      ### Install
      Download the APK below and install on your Android device.
    assets:
      links:
        - name: "ExitZero-${TAG}.apk (Permanent Link)"
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/exitzero/${VERSION}/${APK_NAME}"
          link_type: package
        - name: "ExitZero-latest.apk (Stable Link)"
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/exitzero/latest/ExitZero-latest.apk"
          link_type: package
