stages:
  - build
  - release

variables:
  FLUTTER_VERSION: "stable"

# â”€â”€ Build release APK â”€â”€
build_apk:
  stage: build
  image: ghcr.io/cirruslabs/flutter:latest
  only:
    - main
  before_script:
    - flutter --version
    - flutter pub get
  script:
    - flutter build apk --release
    - |
      VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //')
      TAG="v${VERSION}-build.${CI_PIPELINE_IID}"
      echo "VERSION=$VERSION" >> build.env
      echo "TAG=$TAG" >> build.env
      mkdir -p release
      mv build/app/outputs/flutter-apk/app-release.apk "release/ExitZero-${TAG}.apk"
  artifacts:
    paths:
      - release/
    reports:
      dotenv: build.env
    expire_in: 1 week

# â”€â”€ Create GitLab Release with the APK â”€â”€
create_release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  only:
    - main
  needs:
    - job: build_apk
      artifacts: true
  script:
    - echo "Creating release for $TAG"
  release:
    tag_name: "$TAG"
    name: "ExitZero $TAG"
    description: |
      ðŸš€ **Automated release from `main` branch**

      **Commit:** $CI_COMMIT_SHA
      **Pipeline:** #$CI_PIPELINE_IID

      ### Install
      Download the APK below and install on your Android device.
    assets:
      links:
        - name: "ExitZero-${TAG}.apk"
          url: "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/raw/release/ExitZero-${TAG}.apk"
          link_type: package
