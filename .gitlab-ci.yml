stages:
  - build
  - release

variables:
  FLUTTER_VERSION: "stable"
  # Speed up Gradle
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true"

# â”€â”€ Build release APK â”€â”€
build_apk:
  stage: build
  image: ghcr.io/cirruslabs/flutter:latest
  only:
    - main
  cache:
    # Cache pub packages, Gradle, and Android SDK downloads across runs
    - key: flutter-pub-${CI_COMMIT_REF_SLUG}
      paths:
        - .pub-cache/
        - .dart_tool/
      policy: pull-push
    - key: gradle-cache
      paths:
        - android/.gradle/
        - /root/.gradle/caches/
        - /root/.gradle/wrapper/
      policy: pull-push
  script:
    - flutter pub get
    - flutter build apk --release
    - |
      VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //')
      TAG="v${VERSION}-build.${CI_PIPELINE_IID}"
      echo "VERSION=$VERSION" >> build.env
      echo "TAG=$TAG" >> build.env
      echo "BUILD_JOB_ID=$CI_JOB_ID" >> build.env
      mkdir -p release
      mv build/app/outputs/flutter-apk/app-release.apk "release/ExitZero-${TAG}.apk"
  artifacts:
    paths:
      - release/
    reports:
      dotenv: build.env
    expire_in: 1 week

# â”€â”€ Create GitLab Release with the APK â”€â”€
create_release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  only:
    - main
  needs:
    - job: build_apk
      artifacts: true
  script:
    - echo "Creating release for $TAG"
  release:
    tag_name: "$TAG"
    name: "ExitZero $TAG"
    description: |
      ðŸš€ **Automated release from `main` branch**

      **Commit:** $CI_COMMIT_SHA
      **Pipeline:** #$CI_PIPELINE_IID

      ### Install
      Download the APK below and install on your Android device.
    assets:
      links:
        - name: "ExitZero-${TAG}.apk"
          url: "${CI_PROJECT_URL}/-/jobs/${BUILD_JOB_ID}/artifacts/raw/release/ExitZero-${TAG}.apk"
          link_type: package
