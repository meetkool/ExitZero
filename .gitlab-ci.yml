stages:
  - docker
  - build
  - release

variables:
  FLUTTER_VERSION: "stable"
  # Speed up Gradle
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true"
  # Custom image tag
  CI_IMAGE: "${CI_REGISTRY_IMAGE}/flutter-builder:latest"

# â”€â”€ Build and push custom Docker image â”€â”€
docker_build:
  stage: docker
  image: docker:latest
  services:
    - docker:dind
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - Dockerfile
      when: on_success
    - when: never
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - docker build -t "$CI_IMAGE" .
    - docker push "$CI_IMAGE"

# â”€â”€ Build release APK â”€â”€
build_apk:
  stage: build
  image: ${CI_IMAGE}
  only:
    - main
  cache:
    # Cache pub packages across runs
    - key: flutter-pub-${CI_COMMIT_REF_SLUG}
      paths:
        - .pub-cache/
        - .dart_tool/
      policy: pull-push
  script:
    - flutter pub get
    - flutter build apk --release
    - |
      VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //')
      TAG="v${VERSION}-build.${CI_PIPELINE_IID}"
      echo "VERSION=$VERSION" >> build.env
      echo "TAG=$TAG" >> build.env
      echo "BUILD_JOB_ID=$CI_JOB_ID" >> build.env
      mkdir -p release
      mv build/app/outputs/flutter-apk/app-release.apk "release/ExitZero-${TAG}.apk"
  artifacts:
    paths:
      - release/
    reports:
      dotenv: build.env
    expire_in: 1 week

# â”€â”€ Create GitLab Release with the APK â”€â”€
create_release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  only:
    - main
  needs:
    - job: build_apk
      artifacts: true
  script:
    - echo "Creating release for $TAG"
  release:
    tag_name: "$TAG"
    name: "ExitZero $TAG"
    description: |
      ðŸš€ **Automated release from `main` branch**

      **Commit:** $CI_COMMIT_SHA
      **Pipeline:** #$CI_PIPELINE_IID

      ### Install
      Download the APK below and install on your Android device.
    assets:
      links:
        - name: "ExitZero-${TAG}.apk"
          url: "${CI_PROJECT_URL}/-/jobs/${BUILD_JOB_ID}/artifacts/raw/release/ExitZero-${TAG}.apk"
          link_type: package

# â”€â”€ Publish APK to GitLab Package Registry â”€â”€
publish_package:
  stage: release
  image: curlimages/curl:latest
  needs:
    - job: build_apk
      artifacts: true
  only:
    - main
  script:
    - echo "Publishing package version $VERSION to registry..."
    - |
      curl --header "JOB-TOKEN: $CI_JOB_TOKEN" \
           --upload-file "release/ExitZero-${TAG}.apk" \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/exitzero/${VERSION}/ExitZero-${TAG}.apk"
    - |
      curl --header "JOB-TOKEN: $CI_JOB_TOKEN" \
           --upload-file "release/ExitZero-${TAG}.apk" \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/exitzero/latest/ExitZero-${TAG}.apk"

# â”€â”€ Trigger Pages deployment to update website version â”€â”€
trigger_pages:
  stage: release
  image: curlimages/curl:latest
  needs:
    - job: create_release
      artifacts: false
  only:
    - main
  script:
    - echo "Triggering pages pipeline to update website version..."
    - |
      curl --request POST \
        --form "token=$CI_JOB_TOKEN" \
        --form "ref=pages" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/trigger/pipeline"
